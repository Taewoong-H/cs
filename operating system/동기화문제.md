# 동기화 문제

공유된 자원에 여러 프로세스가 동시에 접근하면서 문제가 발생할 수 있다. 이 때 공유된 자원의 데이터는 한번에 하나의 프로세스만 접근할 수 있도록 제한을 둬야 한다.

### 스레드 동기화

1. 실행 순서의 동기화: 스레드의 실행 순서를 정의하고, 이 순서를 반드시 따르도록 하는 것.
2. 메모리 접근에 대한 동기화
   - 메모리 접근에 있어서 동시 접근을 막는 것.
   - 실행의 순서가 중요한 것이 아니라 한 순간에 하나의 스레드만 해당 자원에 접근하도록 하는 것.

### 동기화 기법

- 유저 모드의 동기화
  - 커널의 힘을 빌리지 않는 동기화 기법
  - 성능상 이점이 있으나 기능상의 제한점이 존재
  - 임계 구역 기반의 동기화, 인터락 함수 기반의 동기화
- 커널 모드의 동기화
  - 커널에서 제공하는 동기화 기능을 이용하는 방법.
  - 커널 모드로의 변경이 필요하고 이는 성능 저하로 이어진다. 그러나 다양한 기능을 활용할 수 있다.
  - 세마포어, 뮤텍스, 모니터 등등.

#### 유저모드의 동기화

1. 임계 구역 기반의 동기화

- 열쇠를 얻은 프로세스만 임계 구역에 들어갈 수 있다. 즉, 한번에 하나의 스레드만이 접근 가능하다.
- 임계 구역 진입을 위해 크리티컬 섹션 오브젝트를 얻는다.
- 다른 스레드가 열쇠를 가지고 있을 시에는 반환할 때까지 블로킹된다. 열쇠가 반환되면 블로킹 상태에서 빠져나와 열쇠를 얻고 임계 구역에 접근한다.

2. 인터락 함수 기반의 동기화

- 함수 내부적으로 한 순간에 하나의 스레드에 의해서만 실행되도록 동기화된다.
- 임계 구역 기반의 동기화도 내부적으로 인터락 함수를 기반으로 구현된다.
- 유저 모드 기반으로 동작해서 속도가 빠르다.

#### 커널모드의 동기화

1. 세마포어(Semaphore)

- 공유된 자원의 데이터를 여러 프로세스, 스레드가 접근하는 것을 막는 것.
- 동시에 접근할 수 있는 '허용 가능한 갯수'를 가지고 있는 Counter.(공유자원에 접근할 수 있는 스레드 혹은 프로세스의 수를 나타내는 값, -> 공통으로 관리하는 하나의 값)
- EX)
  - 화장실을 예로 들어보자. 세마포어는 1개 이상의 열쇠라고 할 수 있다. 화장실 칸이 4개이고 열쇠가 4개라면, 4명까지는 대기없이 바로 사용할 수 있다. 그 다음부터는 대기를 해야한다. 이것이 바로 세마포어이다.
- 세마포어 Counter의 갯수에 따라 다음과 같이 나뉜다.
  - 1개: Binary Semaphore(뮤텍스와 같다.)
  - 2개 이상: Counting Semaphore
- 세마포어는 소유할 수 없다.
  - 세마포어를 소유하지 않는 스레드가 세마포어를 해제할 수 있는 문제가 발생한다.

2. 뮤텍스(Mutual Exclusion)

- 공유된 자원의 데이터를 여러 프로세스, 스레드가 접근하는 것을 막는 것이다.
- 임계 구역을 가진 스레드들의 Running time이 서로 겹치지 않게 각각 단독으로 실행되게 하는 기술이다.

* **뮤텍스 객체를 두 스레드가 동시에 사용할 수 없다.**
* 일종의 Locking 매커니즘으로 공유 자원에 대한 접근을 조율하기 위해 locking과 unlocking을 사용한다.
* Lock: 현재 임계 구역에 들어갈 권한을 얻어옴(만약 다른 프로스세/스레드가 임계 구역 수행 중이면 종료할 때 까지 대기)
* Unlock: 현재 임계 구역을 모두 사용했음을 알림.(대기 중인 다른 프로세스/스레드가 임계 구역에 진입할 수 있음)
* 뮤텍스는 무조건 1개의 열쇠만 가질 수 있다. 열쇠를 가진 사람만이 화장실에 갈 수 있고, 다음 사람이 화장실에 가기 위해서는 앞 사람이 열쇠를 반납해야한다.

3. 모니터(Monitor)

- Mutex(Lock)와 Condition Variables를 가지고 있는 Synchronization 매커니즘이다.

> 뮤텍스와 모니터는 상호 배제를 함으로써 임계 구역에 하나의 쓰레드만 들어갈 수 있다.
> 반면, 세마포어는 하나의 쓰레드만 들어가거나 혹은 여러개의 쓰레드가 들어가게 할 수도 있다.

#### Q. 임계영역이란?

> 여러 프로세스가 데이터를 공유하며 수행될 때, 각 프로세스에서 공유 데이터를 접근하는 프로그램 코드 부분

- 임계 영역에서 동기화를 진행하지 못하면 치명적인 문제가 발생.
- 따라서 임계 구역 문제를 해결하기 위해서는 3가지 필수 조건이 있다.
  1. 상호 배제(Mutual exclusion): 프로세스 P1이 공유 자원을 접근하는 임계 구역 코드를 수행하고 잇으면 다른 프로세스들은 공유 자원을 접근하는 임계 구역 코드를 수행할 수 없다. 즉, 한 순간에 하나의 스레드만이 실행될 수 있다.
  2. 진행(Progress): 임계 구역에서 실행중인 프로세스가 없고 별도의 동작이 없는 프로세스들만 임계 구역 진입 후보로서 참여될 수 있다.
  3. 한정된 대기(Bounded Waiting): P1이 임계 구역에 진입 신청 후부터 받아들여질때까지, 다른 프로세스들이 임계 구역에 진입하는 횟수는 제한이 있어야 한다.

### 요약

뮤텍스: 한 스레드, 프로세스에 의해 소유될 수 있는 key를 기반으로 한 상호배제 기법
세마포어: 현재 공유자원에 접근할 수 있는 스레드, 프로세스의 수를 나타내는 값을 두어 상호배제를 달성하는 기법

**뮤텍스와 세마포어의 목적은 특정 동기화 대상이 이미 특정 스레드나 프로세스에 의해 사용중일 경우, 다른 스레드가 해당 동기화 대상에 접근하는 것을 제한하는 것으로 동일하지만, 관리하는 동기화 대상이 몇개인가에 따라 차이가 생긴다.**
